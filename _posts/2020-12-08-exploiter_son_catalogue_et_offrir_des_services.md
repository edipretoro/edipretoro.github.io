---
layout: post
title: Exploiter son catalogue, et offrir des services supplémentaires
category: [LIS Advent Calendar]
tags: [Python, API, FastAPI, Système de recommandation]
published: true
comments: true
--- 

Nous avons vu ensemble il y a [quelques jours]({% post_url
2020-12-06-recommander_des_ressources %}) qu'il était possible de
recommander à un lecteur des titres en se basant sur les données de
prêts. Mais je me suis limité à une présentation technique de la
méthode, sans creuser davantage la mise en place concrète. Dans ce
billet, je vais vous expliquer comment cette fonctionnalité pourrait
être intégrée dans un catalogue. 

Mais avant de rentrer dans vif du sujet, une petite remarque : j'avais
précédemment travaillé du point de vue du lecteur ; mais dans ce qui
suit, je travaillerai du point de vue d'une ressource. La méthode en
elle-même ne change pas, mais le résultat est plus proche de la
fonctionnalité « Les clients ayant consulté cet article ont également
regardé » d'une grande enseigne en ligne.

Le jeu de données étant toujours à ma disposition, j'aurai besoin pour
ce prototype :

* D'un traitement des données pour être orienté ressources ;
* D'une méthode pour intégrer facilement le résultat de la
  recommandation dans un page web (et oui, je partirai du principe que
  mon catalogue est disponible via une page web !)
  
Allons-y !

## Traitement du jeu de données

En bref, je dois passer de :

```json
{
	"Lecteur 1" : {
		"Titre 1": 1,
		"Titre 2": 1
	},
	"Lecteur 2" : {
		"Titre 3": 1,
		"Titre 4": 1
	},
	"Lecteur 3" : {
		"Titre 1": 1,
		"Titre 3": 1
	}
}
```

à 

```json
{
	"Titre 1" : {
		"Lecteur 1": 1,
		"Lecteur 3": 1
	},
	"Titre 2" : {
		"Lecteur 1": 1,
	},
	"Titre 3" : {
		"Lecteur 2": 1,
		"Lecteur 3": 1
	},
	"Titre 4": {
		"Lecteur 2": 1
	}
}
```

Et appliquer les traitements déjà présentés. 

## Permettre l'intégration des recommandations

Pour faciliter la réutilisation des recommandations, nous allons créer
une interface de programmation (*Application Programming Interface*, à
savoir une API). Cette dernière sera disponible sur via le protocole
HTTP, et ce sera donc un service web. 

Voici le code :

```python
import json
import pathlib

from fastapi import FastAPI
import isbnlib

app = FastAPI()


@app.get("/suggest")
def suggest(isbn: str):
	# Je charge un jeu de données avec l'ISBN en correspondance avec
    # le titre
    isbn_dataset = json.loads(pathlib.Path("./isbn.json").read_text())
	
	# Je crée un nouveau jeu de données en « inversant » le
    précédent : le titre en correspondance avec l'ISBN
    titles_dataset = {v: k for k, v in isbn_dataset.items()}
	
	# Je charge le jeu de données avec les similarités entre les ressources
    items_dataset = json.loads(pathlib.Path("./items.json").read_text())

	# Je nettoie l'ISBN soumis par l'utilisateur de l'API
    canon_isbn = isbnlib.canonical(isbn)
	
	# J'ajoute l'ISBN dans le réponse qui sera retournée à la fin du traitement
    results = {"isbn": canon_isbn}

	# 1er cas de figure, nous n'avons pas cet ISBN dans notre catalogue
    if canon_isbn not in isbn_dataset:
        results["message"] = "We don't have recommendations for this ISBN."
    else:
		# Nous récupérons le titre de la ressource et nous l'ajoutons
        # dans la réponse
        title = isbn_dataset[canon_isbn]
        results["title"] = title
		
		# 2e cas de figure, nous avons la ressource, mais elle n'a
        # jamais été empruntée, et donc, pas de recommandations
        if title not in items_dataset:
            results["message"] = "We don't have recommendations for this ISBN."
        else:
			# 3e cas de figure, nous avons toutes les infos
            results["recommendations"] = []
            for _, t in items_dataset[title]:
                results["recommendations"].append({
                    "title": t,
                    "isbn": titles_dataset[t]
                })

    return results
```

En lançant ce service, par exemple avec la commande suivante `uvicorn
'isbn_api:app', je peux maintenant l'interroger en lui soumettant un
ISBN.

Essayons d'abord avec un ISBN erroné :

```shell
curl -s http://localhost:8000/suggest?isbn=9782707159336|jq .
```

qui nous donnera le résultat suivant : 

```json
{
  "isbn": "9782707159336",
  "message": "We don't have recommendations for this ISBN."
}
```

Essayons maintenant avec un ISBN correct : 

```shell
curl -s http://localhost:8000/suggest?isbn=9782707159335|jq .
```

qui donnera le résultat :

```json
{
  "isbn": "9782707159335",
  "title": "Introduction aux sciences de l'information",
  "recommendations": [
    {
      "title": "Big, fast & opendata",
      "isbn": "9782364051218"
    },
    {
      "title": "Usages et usagers de l'information",
      "isbn": "9782843651410"
    },
    {
      "title": "Système 1 - système 2",
      "isbn": "9782081211476"
    },
    {
      "title": "Supra-coronada",
      "isbn": "9782507001797"
    },
    {
      "title": "Quand la bibliothèque se rend en maison de repos",
      "isbn": "23412"
    },
    {
      "title": "Principes directeurs pour l'application des ISBD[CP] à la description des parties composantes",
      "isbn": "9782871300236"
    },
    {
      "title": "Pratiquer la CNV au travail",
      "isbn": "9782729612603"
    },
    {
      "title": "Petite philosophie des grandes trouvailles",
      "isbn": "9782212547306"
    },
    {
      "title": "Passez au design Thinking",
      "isbn": "9782212570595"
    },
    {
      "title": "Marketing 3.0",
      "isbn": "9782804171308"
    },
    {
      "title": "Les pratiques de l'équipe agile",
      "isbn": "9782807323032"
    },
    {
      "title": "Les particules élémentaires",
      "isbn": "9782290303054"
    },
    {
      "title": "Les institutions de l'Union européenne",
      "isbn": "9782110039422"
    },
    {
      "title": "Les décisions absurdes",
      "isbn": "9782070315420"
    },
    {
      "title": "Les commencements",
      "isbn": "2053"
    },
    {
      "title": "Les bibliothèques municipales en France après le tournant Internet",
      "isbn": "9782842461034"
    },
    {
      "title": "Le marketing de soi",
      "isbn": "9782212557008"
    },
    {
      "title": "Le management du personnel en bibliothèques",
      "isbn": "9782765408130"
    },
    {
      "title": "Le guide des bibliothèques numériques",
      "isbn": "9782916571621"
    },
    {
      "title": "Le documentaliste manager de son équipe",
      "isbn": "9782843650345"
    }
  ]
}
```

En publiant cette API sur le web, il est maintenant possible de
modifier l'interface HTML de votre catalogue pour y ajouter cette
fonctionnalité. 

Bon, je n'ai pas d'OPAC sous la main, mais voici que cela pourrait
donner :

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>My Tiny OPAC</title>
    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
  </head>
  <body>
    <h1>My Tiny OPAC</h1>
    <form>
      <input type="text" name="isbn" id="isbn">
      <button type="button" id="search">Des recommandations ?</button>
    </form>
    <div id="results"></div>
  </body>
  <script>
    $( document ).ready(function() {
	let endpoint = 'http://localhost:8000/suggest?isbn='
	$("#search").click(function() {
	    $("#results").empty();
	    $.ajax({
		url: endpoint + $("#isbn").val(),
		type: 'GET',
		processData: false,
		success: function (content) {
		    $("#results").append(
			"<p>Si vous aimez « <em>" + content.title + "</em> » (ISBN : " + content.isbn + "), vous serez peut-être intéressé par :</p>"
		    );
		    $("#results").append(
			"<ol>"
		    );
		    $.each(content.recommendations, function(i, o){
			$("#results").append(
			    "<li>" + o.title + " (ISBN : " + o.isbn + ")</li>"
			)
		    });	
		    $("#results").append(
			"</ol>"
		    )
		},
		error: function(req, err){
		    console.log('my message' + err);
		}
		
	    })
	})
    });
  </script>
</html>
```

Et cela ressemble visuellement à ce ceci :

![L'OPAC vide](/assets/img/20201208-01.png)

Et quand on clique sur le bouton après avoir saisi un ISBN :

![L'OPAC avec les recommandations](/assets/img/20201208-02.png)
